# Labkit Test Suite Makefile
# ç”¨äºç®¡ç†å’Œè¿è¡Œ labkit çš„æ‰€æœ‰æµ‹è¯•

.PHONY: help all test-models test-events test-network test-validator test-labkit test-builders clean clean-test-files

# é»˜è®¤ç›®æ ‡
help:
	@echo "Labkit Test Suite å‘½ä»¤:"
	@echo ""
	@echo "ğŸ§ª æµ‹è¯•å‘½ä»¤:"
	@echo "  make all              - è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  make test-models      - æµ‹è¯•åŸºç¡€æ¨¡å‹åˆ›å»ºå’ŒéªŒè¯"
	@echo "  make test-events      - æµ‹è¯•äº‹ä»¶æ¨¡å‹ç³»ç»Ÿ"
	@echo "  make test-network     - æµ‹è¯•ç½‘ç»œé…ç½®æ¨¡å‹å’Œ YAML ç”Ÿæˆ"
	@echo "  make test-validator   - æµ‹è¯• YAML æ–‡ä»¶éªŒè¯å™¨"
	@echo "  make test-labkit      - æµ‹è¯•å®Œæ•´çš„ labkit åŠŸèƒ½"
	@echo "  make test-builders    - æµ‹è¯•ç½‘ç»œæ‹“æ‰‘æ„å»ºå™¨"
	@echo ""
	@echo "ğŸ”§ å·¥å…·å‘½ä»¤:"
	@echo "  make validate-file    - éªŒè¯å•ä¸ª YAML æ–‡ä»¶"
	@echo "  make validate-dir     - éªŒè¯å®éªŒç›®å½•"
	@echo ""
	@echo "ğŸ§¹ æ¸…ç†å‘½ä»¤:"
	@echo "  make clean            - æ¸…ç†æµ‹è¯•ç”Ÿæˆçš„æ–‡ä»¶"
	@echo "  make clean-test-files - æ¸…ç†æµ‹è¯•åˆ›å»ºçš„ä¸´æ—¶æ–‡ä»¶"
	@echo ""
	@echo "ğŸ“‹ æµ‹è¯•è¯´æ˜:"
	@echo "  test-models:    éªŒè¯ Pydantic æ¨¡å‹åˆ›å»ºã€å­—æ®µéªŒè¯ã€ç±»å‹æ£€æŸ¥"
	@echo "  test-events:    éªŒè¯äº‹ä»¶ç³»ç»Ÿæ¨¡å‹ï¼ˆEventTypeã€NodeExecArgs ç­‰ï¼‰"
	@echo "  test-network:   éªŒè¯ç½‘ç»œé…ç½®æ¨¡å‹ã€YAML åºåˆ—åŒ–ã€å­—æ®µæ’åº"
	@echo "  test-validator: éªŒè¯ YAML æ–‡ä»¶éªŒè¯å™¨åŠŸèƒ½"
	@echo "  test-labkit:    éªŒè¯å®Œæ•´çš„ labkit SDK åŠŸèƒ½"
	@echo "  test-builders:  éªŒè¯ç½‘ç»œæ‹“æ‰‘æ„å»ºå™¨åŠŸèƒ½"
	@echo ""
	@echo "ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹:"
	@echo "  # è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  make all"
	@echo ""
	@echo "  # åªæµ‹è¯•ç½‘ç»œé…ç½®"
	@echo "  make test-network"
	@echo ""
	@echo "  # éªŒè¯ç‰¹å®šæ–‡ä»¶"
	@echo "  make validate-file FILE=../network_config_ordered.yaml"
	@echo ""
	@echo "  # éªŒè¯å®éªŒç›®å½•"
	@echo "  make validate-dir DIR=../test_experiment"

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
all: test-models test-events test-network test-validator test-labkit test-builders
	@echo ""
	@echo "ğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼"

# æµ‹è¯•åŸºç¡€æ¨¡å‹
test-models:
	@echo "ğŸ§ª æµ‹è¯•åŸºç¡€æ¨¡å‹..."
	@cd .. && python3 -c "from labkit.models import *; print('âœ… æ¨¡å‹å¯¼å…¥æˆåŠŸ')"
	@echo "âœ… åŸºç¡€æ¨¡å‹æµ‹è¯•é€šè¿‡"

# æµ‹è¯•äº‹ä»¶æ¨¡å‹
test-events:
	@echo "ğŸ§ª æµ‹è¯•äº‹ä»¶æ¨¡å‹..."
	@cd .. && python3 test/test_events.py
	@echo "âœ… äº‹ä»¶æ¨¡å‹æµ‹è¯•é€šè¿‡"

# æµ‹è¯•ç½‘ç»œé…ç½®
test-network:
	@echo "ğŸ§ª æµ‹è¯•ç½‘ç»œé…ç½®..."
	@cd .. && python3 test/test_network_config.py
	@echo "âœ… ç½‘ç»œé…ç½®æµ‹è¯•é€šè¿‡"

# æµ‹è¯•éªŒè¯å™¨
test-validator:
	@echo "ğŸ§ª æµ‹è¯• YAML éªŒè¯å™¨..."
	@cd .. && python3 test/test_validator.py
	@echo "âœ… éªŒè¯å™¨æµ‹è¯•é€šè¿‡"

# æµ‹è¯•å®Œæ•´ labkit åŠŸèƒ½
test-labkit:
	@echo "ğŸ§ª æµ‹è¯•å®Œæ•´ labkit åŠŸèƒ½..."
	@cd .. && python3 test/test_labkit.py
	@echo "âœ… labkit åŠŸèƒ½æµ‹è¯•é€šè¿‡"

# æµ‹è¯•ç½‘ç»œæ‹“æ‰‘æ„å»ºå™¨
test-builders:
	@echo "ğŸ§ª æµ‹è¯•ç½‘ç»œæ‹“æ‰‘æ„å»ºå™¨..."
	@cd .. && python3 test/test_builders.py
	@echo "âœ… ç½‘ç»œæ‹“æ‰‘æ„å»ºå™¨æµ‹è¯•é€šè¿‡"

# éªŒè¯å•ä¸ª YAML æ–‡ä»¶
validate-file:
	@if [ -z "$(FILE)" ]; then \
		echo "âŒ è¯·æŒ‡å®šæ–‡ä»¶è·¯å¾„: make validate-file FILE=path/to/file.yaml"; \
		exit 1; \
	fi
	@echo "ğŸ” éªŒè¯æ–‡ä»¶: $(FILE)"
	@cd .. && python3 test/labkit_validate.py "$(FILE)" --verbose

# éªŒè¯å®éªŒç›®å½•
validate-dir:
	@if [ -z "$(DIR)" ]; then \
		echo "âŒ è¯·æŒ‡å®šç›®å½•è·¯å¾„: make validate-dir DIR=path/to/experiment"; \
		exit 1; \
	fi
	@echo "ğŸ” éªŒè¯å®éªŒç›®å½•: $(DIR)"
	@cd .. && python3 test/labkit_validate.py --experiment "$(DIR)" --verbose

# æ¸…ç†æµ‹è¯•ç”Ÿæˆçš„æ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†æµ‹è¯•æ–‡ä»¶..."
	@rm -f ../*.yaml
	@rm -f ../invalid_*.yaml
	@rm -rf ../test_experiment
	@echo "âœ… æ¸…ç†å®Œæˆ"

# æ¸…ç†æµ‹è¯•åˆ›å»ºçš„ä¸´æ—¶æ–‡ä»¶
clean-test-files:
	@echo "ğŸ§¹ æ¸…ç†æµ‹è¯•ä¸´æ—¶æ–‡ä»¶..."
	@rm -f ../labbook.yaml
	@rm -f ../playbook.yaml
	@rm -f ../invalid_*.yaml
	@rm -rf ../test_experiment
	@echo "âœ… ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"

# æ˜¾ç¤ºæµ‹è¯•çŠ¶æ€
status:
	@echo "ğŸ“Š æµ‹è¯•æ–‡ä»¶çŠ¶æ€:"
	@echo "  test_models.py     - åŸºç¡€æ¨¡å‹æµ‹è¯•"
	@echo "  test_events.py     - äº‹ä»¶æ¨¡å‹æµ‹è¯•"
	@echo "  test_network_config.py - ç½‘ç»œé…ç½®æµ‹è¯•"
	@echo "  test_validator.py  - éªŒè¯å™¨æµ‹è¯•"
	@echo "  test_labkit.py     - å®Œæ•´åŠŸèƒ½æµ‹è¯•"
	@echo "  labkit_validate.py - YAML éªŒè¯å·¥å…·"
	@echo ""
	@echo "ğŸ“ æµ‹è¯•æ–‡ä»¶ä½ç½®: $(PWD)"
	@echo "ğŸ Python ç¯å¢ƒ: $(shell which python3)" 