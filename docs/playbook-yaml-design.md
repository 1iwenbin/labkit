# `playbook.yaml` 设计规范 (最终版)

**文档目的:** 本文档是 `Labbook` 规范的核心组成部分，旨在最终确定 `playbook.yaml` 文件的定位、设计哲学、结构与核心组件。它是 `Labbook` 的“动态核心”，是整个实验的“自动化剧本”和“行动纲领”。

## 1. 核心定位与设计哲学

- **最终命名:** `playbook.yaml`
- **核心定位:** `playbook.yaml` 是实验的**动态流程编排文件**。它通过一个强大的**“双轨制”执行模型**，将“背景事件”与“主动测试流程”清晰地分离。
- **设计哲学:**
    1. **舞台与规程分离:** `playbook` 清晰地区分了两种流程：
        - **`timeline` (背景时间线):** 一系列不可阻塞的、按绝对时间驱动的异步背景事件，它构成了“动态变化的世界”。
        - **`procedure` (实验规程):** 一个或多个独立的、可阻塞的同步测试序列，它代表了实验者想要执行的核心测试流程，遵循严谨的、一步接一步的操作规程。
    2. **原子化与封装:** `playbook` 只负责编排**原子化的步骤**。任何复杂的连续动作，都应被封装在一个单一的 `action` 的实现内部。
    3. **双模式条件:** 平台同时提供高效的内置**声明式 (`declarative`)** 条件和灵活的自定义**命令式 (`command`)** 条件。
    4. **作用域明确:** 流程控制（如 `run_if`, `wait_for`）的作用域被严格限定。`run_if` 只影响其所在的单个步骤；`wait_for` 只阻塞其所在的单个 `procedure`。

## 2. 文件结构

`playbook.yaml` 的顶层是一个对象，包含三个有特殊功能的保留名称：`conditions`, `timeline`, 和 `procedure`。

```
# 可选：定义所有可复用的条件
conditions:
  # ...

# 可选：定义不可阻塞的、按绝对时间戳触发的背景事件
timeline:
  # ...

# 可选：定义一个或多个独立的、有序的、可阻塞的“实验规程”
procedure:
  # ...

# (可选的 teardown 块也可以存在，用于自定义清理)

```

## 3. 核心组件详细规范

### 3.1. `conditions` 块 (条件库)

- **功能:** 定义一个可复用的“条件库”。
- **`type`:** 支持两种模式：`declarative` (默认) 和 `command`。
    - `declarative`: 通过 `query` + `rule` 模型进行高效检查。
    - `command`: 通过在目标节点内执行 `command`，并根据其**退出码** (`0`为`true`)来判断条件。

### 3.2. `timeline` 块 (背景时间线)

- **功能:** 定义一系列不可阻塞的、按绝对时间戳 (`at`) 触发的背景事件。
- **结构:** 一个**步骤 (Step) 对象的列表**。
- **约束:** 此块中的步骤**不允许**使用 `wait_for`。每个步骤都是“即发即忘”的。

### 3.3. `procedure` 块 (实验规程)

- **功能:** 定义一个或多个独立的、有序的、可阻塞的测试序列。
- **结构:** 一个**规程 (Procedure) 对象的列表**。
- **规程对象字段:**
    - `id` (string, 必需): 该规程的唯一名称。
    - `trigger_at` (string, 必需): 定义该规程**开始执行**的绝对时间点。
    - `steps` (array, 必需): 一个**有序的步骤列表**，按顺序串行执行。

### 3.4. 步骤 (Step) 对象规范

“步骤 (Step)”是构成 `timeline` 和 `procedure` 的基本单位。

- **在 `timeline` 中:** 步骤必须包含 `at` 和 `description` 字段。
- **在 `procedure` 的 `steps` 列表中:** 步骤**不包含 `at` 字段**，其执行时机由前一个步骤是否完成决定。

**步骤的行为定义字段 (互斥):** 一个步骤对象中，必须有且仅有以下三个键之一：`action`, `run_if`, `wait_for`。

- **`action` (单一动作):**
    - 执行一个单一的、原子的操作 (`event`, `query`, `monitor`)。
    - 可与 `assert` 结合，对 `query` 的结果进行断言。
- **`run_if` (条件执行 - 类似 `if`):**
    - **非阻塞**。在步骤执行时**检查一次**条件。
    - 如果条件为 `true`，则执行其包含的 `action`。否则直接跳过。
    - **它只影响其所在的单个步骤，不影响后续步骤的执行。**
- **`wait_for` (等待条件 - 类似带超时的 `while`):**
    - **只能在 `procedure` 中使用。**
    - **阻塞**。在步骤执行时开始，**反复检查**条件，直到条件满足或超时。
    - **它只会阻塞当前所在的 `procedure`**，不影响 `timeline` 或其他 `procedure` 的执行。

## 4. 结论

`Labbook` 的 `playbook.yaml` 最终规范，通过将“背景时间线 (`timeline`)”与“实验规程 (`procedure`)”清晰分离，构建了一套能够精确描述复杂并行场景的强大框架。它通过原子化的步骤设计和作用域明确的流程控制，在保证了强大功能的同时，也为用户和平台实现者提供了无与伦比的清晰性、健壮性和可扩展性。